# Инструменты обработки изображений для OCR

Этот проект содержит набор инструментов командной строки для обработки изображений, в частности для подготовки к оптическому распознаванию символов (OCR). Инструменты предназначены для обработки различных аспектов обработки изображений, от разделения PDF до сравнения текста, с акцентом на материалы на кабардинском языке.

## Структура проекта

```
/cli/
├── __init__.py
├── __main__.py
├── apply_img_filters.py
├── box_processing.py
├── join_jpeg_to_pdf.py
├── logic/
│   ├── __init__.py
│   ├── apply_img_filters.py
│   ├── box_processing.py
│   ├── cli_utils.py
│   ├── cv/
│   │   ├── __init__.py
│   │   ├── const.py
│   │   ├── detectors.py
│   │   ├── drawing.py
│   │   ├── filters.py
│   │   ├── io.py
│   │   └── modifications.py
│   ├── rotate_img.py
│   ├── smooth_img.py
│   ├── split_book_layout.py
│   └── standartize.py
├── ocr_text_diff.py
├── rotate_img.py
├── run_tesseract_for_page.py
├── smooth_img.py
├── split_book_layout.py
├── split_pdf_to_jpeg.py
├── standartize_img.py
└── unpaper_img.py
```

## Возможности

1. **Разделение PDF**: Конвертация PDF файлов в отдельные JPEG изображения.
2. **Поворот изображений**: Автоматическое определение и исправление поворота изображения.
3. **Сглаживание изображений**: Применение фильтров сглаживания для улучшения качества изображения.
4. **Разделение макета книги**: Разделение макетов с двумя страницами на отдельные страницы.
5. **Обработка OCR**: Запуск Tesseract OCR на обработанных изображениях с поддержкой кабардинского языка.
6. **Сравнение текста**: Сравнение результатов OCR для оценки точности.
7. **Стандартизация изображений**: Настройка размеров изображения до стандартного размера.
8. **Обработка Unpaper**: Очистка отсканированных изображений документов.
9. **Фильтрация изображений**: Применение различных фильтров для улучшения качества изображения для OCR.
10. **Обработка областей**: Извлечение и обработка конкретных областей (боксов) из изображений.

## Установка

1. Клонируйте репозиторий:
   ```
   git clone https://github.com/yourusername/ocr-image-processing-tools.git
   cd ocr-image-processing-tools
   ```

2. Установите необходимые зависимости:
   ```
   pip install -r requirements.txt
   ```

3. Убедитесь, что у вас установлен Tesseract OCR в системе. Для поддержки кабардинского языка может потребоваться установка дополнительных языковых данных.

4. Установите дополнительные инструменты командной строки:
   - `img2pdf`: Для объединения изображений в PDF
   - `unpaper`: Для очистки отсканированных изображений
   - `convert` из ImageMagick: Для конвертации форматов изображений и манипуляций с ними

## Использование

Перейдите в директорию `cli` перед запуском команд:

```sh
cd app/cli
```

### Конвертация PDF в JPEG
Разделение PDF файла на отдельные JPEG изображения:

```shell
sh split_pdf_to_jpeg.sh Къалэмбии_Адыгэ_хъыбархэр_1978.pdf
```

### Разделение макета книги
Разделение макетов с двумя страницами на отдельные страницы:

```shell
python split_book_layout.py -d ../../media/tmp_processing/Къалэмбии_Адыгэ_хъыбархэр_1978.pdf -o ../../media/tmp_processing/Къалэмбии_Адыгэ_хъыбархэр_1978.pdf_splitted
```

### Поворот изображений
Автоматическое определение и исправление поворота изображения:

```shell
python rotate_img.py -d ../../media/tmp_processing/Къалэмбии_Адыгэ_хъыбархэр_1978.pdf_splitted -o ../../media/tmp_processing/Къалэмбии_Адыгэ_хъыбархэр_1978.pdf_rotated
```

### Сглаживание изображений
Применение фильтров сглаживания для улучшения качества изображения:

```shell
python smooth_img.py -d ../../media/tmp_processing/Къалэмбии_Адыгэ_хъыбархэр_1978.pdf_rotated -o ../../media/tmp_processing/Къалэмбии_Адыгэ_хъыбархэр_1978.pdf_smoothened
```

### Фильтрация изображений
Применение различных фильтров для улучшения качества изображения для OCR:

```shell
python apply_img_filters.py -d ../../media/tmp_processing/Къалэмбии_Адыгэ_хъыбархэр_1978.pdf_smoothened -o ../../media/tmp_processing/Къалэмбии_Адыгэ_хъыбархэр_1978.pdf_processed -g 1
```

### Обработка областей
Извлечение и обработка конкретных областей (боксов) из изображений:

```shell
python -m cli box-processing -d data/dag_results/data/dag_results/pdf_processing/Къалэмбии_Адыгэ_хъыбархэр_1978__orig.pdf/rslt_collected_3_from_oshamaho_new_font_0.193_4395_18400/jpgs -o data/dag_results/data/dag_results/pdf_processing/Къалэмбии_Адыгэ_хъыбархэр_1978__orig.pdf/rslt_collected_3_from_oshamaho_new_font_0.193_4395_18400/boxes
```

### Обработка OCR
Запуск OCR на обработанных изображениях:

```shell
make all PDF_FILE=111-shorten-a-ti-pashchie-bechmyrze
```

### Объединение обработанных изображений в PDF
Использование `img2pdf` для объединения обработанных изображений в один PDF:

```shell
img2pdf ../data/pdf_processed/111-shorten-a-ti-pashchie-bechmyrze.pdf_processed/B1.4__C1.7__S1.4/*.jpg --pagesize A4 -o ../data/pdf_processed/111-shorten-a-ti-pashchie-bechmyrze.pdf_processed/B1.4__C1.7__S1.4.pdf
```

### OCR с поддержкой кабардинского языка
Использование `ocrmypdf` с моделью кабардинского языка для OCR:

```shell
ocrmypdf --pages 1-50 -l kbd_finetuned5_0.023_908_26600 --force-ocr --clean --clean-final --deskew --unpaper-args '--layout single' C1.7__B1.4__S1.4.pdf C1.7__B1.4__S1.ocr.pdf
```

### Предобработка изображений для Unpaper
Конвертация изображения в черно-белый формат .pnm:

```shell
convert -density 300 -resize 2481x3507 -black-threshold 70% -white-threshold 75% image.jpg image_bw.pnm
```

### Обработка Unpaper
Очистка отсканированных изображений документов:

```shell
unpaper --layout single --black-threshold 0.1 image_bw.pnm image_bw_unpaper.pnm
```

### Конвертация обработанного изображения обратно в JPG
Конвертация обработанного unpaper изображения обратно в формат JPG:

```shell
convert image_bw_unpaper.pnm -compress jpeg -quality 100 image_bw_unpaper.jpg
```

### Объединение изображений и применение OCR в один шаг
Объединение изображений в PDF и применение OCR одной командой:

```shell
img2pdf my-images*.jpg | ocrmypdf - myfile.pdf
```

## Использование Makefile

Этот проект включает Makefile, который упрощает выполнение всего процесса обработки изображений. Makefile автоматизирует процесс конвертации PDF в изображения, применения различных преобразований и объединения обработанных изображений обратно в PDF.

### Переменные

Вы можете настроить следующие переменные при запуске команд make:

- `PDF_FILE`: Имя PDF файла для обработки (по умолчанию: Къалэмбии_Адыгэ_хъыбархэр_1978.pdf)
- `PDF_DIR`: Директория, содержащая входные PDF файлы (по умолчанию: ../data/pdfs)
- `TMP_PROCESSING_DIR`: Директория для временных файлов во время обработки (по умолчанию: ../data/pdf_processed/$(PDF_FILE))

### Доступные команды

Чтобы увидеть все доступные команды, выполните:

```shell
make help
```

Это отобразит список команд с описаниями.

### Запуск полного процесса

Для запуска всего процесса обработки с настройками по умолчанию:

```shell
make all
```

Для запуска процесса с исключением определенных шагов:

```shell
make all EXCLUDE="split-book-layout rotate-images"
```

### Отдельные шаги

Вы также можете запускать отдельные шаги процесса:

```shell
make split-pdf-to-jpeg
make split-book-layout
make unpaper-images
make rotate-images
make apply-image-filters
make standartize-images
make join-images-to-pdf
```

### Очистка

Для очистки временных директорий после обработки:

```shell
make clean-tmp-dir
```

### Проверка результатов

Для проверки результатов обработки:

```shell
make check-result
```

### Настройка процесса

Makefile определяет набор шагов по умолчанию в переменной `DEFAULT_STEPS`. Вы можете изменить эту переменную, чтобы изменить порядок операций или добавить/удалить шаги из процесса по умолчанию.

## Структура Makefile

Makefile организован в несколько разделов:

1. Определения переменных для путей к файлам и директориям
2. Определения цветов для вывода в консоль
3. Шаги обработки по умолчанию
4. Определения отдельных целей для каждого шага обработки
5. Цель `all`, которая запускает весь процесс
6. Вспомогательные цели, такие как `clean-tmp-dir` и `check-result`

Makefile использует условную логику для исключения шагов при необходимости и обеспечивает четкий вывод в консоль для каждого шага процесса.

## Лучшие практики при использовании Makefile

1. Всегда проверяйте входной PDF файл и директории перед запуском полного процесса.
2. Используйте опцию `EXCLUDE` для пропуска шагов, которые не нужны для вашего конкретного случая.
3. После обработки используйте команду `check-result` для проверки результата.
4. Очищайте временные файлы с помощью `clean-tmp-dir` после успешной обработки для экономии места на диске.

Используя этот Makefile, вы можете легко обрабатывать целые книги или большие коллекции документов одной командой, что делает процесс подготовки к OCR гораздо более эффективным.

## Расширенное использование

### Настройка фильтров изображений
Вы можете настроить фильтры изображений, применяемые в скрипте `apply_img_filters.py`. Настройки по умолчанию:

```python
DEFAULT_PROCESS_STEPS = [
    ("Brightness", 1.4),
    ("Contrast", 1.9),
    ("Sharpness", 1.7),
]
```

Вы можете изменить эти значения или добавить дополнительные шаги в соответствии с вашими потребностями.

### Конфигурация Tesseract
Проект использует пользовательский файл конфигурации Tesseract, расположенный по адресу:

```
PROJECT_DIR/tesseract/kdb.base.config.txt
```

Вы можете изменить этот файл для настройки поведения Tesseract для лучших результатов с кабардинским текстом.

### Параллельная обработка
Многие скрипты поддерживают параллельную обработку для ускорения операций на больших наборах данных. Вы можете настроить количество рабочих процессов в функции `generic_file_processor` в файле `logic/cli_utils.py`.

## Устранение неполадок

- Если вы столкнулись с проблемами при обработке изображений, попробуйте настроить параметры в соответствующих скриптах (например, размеры размытия, пороги).
- При пробл